<body>
    <link href="https://fonts.googleapis.com/css?family=Quicksand" rel="stylesheet">
    <script src="matter.js"></script>
    <div id="toolbox">
        <div class="container">
            <div class="btn" onclick="location.reload();">
                <span>Reset</span>
            </div>
        </div>
        <div id="instructions">
            <h2>Place your bets!</h2>
            <p>Click the <strong>ragdoll</strong> you think will stay on screen longest.</p>
        </div>
        <div id="running">
            <h2>Good luck!</h2>
            <p id="running-message"></p>
        </div>
        <div id="ranking-container">
            <p id="ranking-message"></p>
            <ul id="ranking"></ul>
        </div>
    </div>
    <style>
        body {
            margin: 0;
            font-family: 'Quicksand', sans-serif;

        }


        #toolbox {

            position: fixed;
            width: 10em;
            height: calc(100vh - 120px - 3em);
            margin-left: 1em;
            margin-top: 120px;
            z-index: 1;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            padding: 1em;
            color: rgba(255, 255, 255, 0.8);
        }

        #ranking {
            padding-left: 1em;
            list-style-type: circle;

        }

        #running {
            display: none;
        }

        .btn {
            position: relative;
            margin: 0 auto;
            width: 100%;
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 4px;
            text-transform: uppercase;
            text-align: center;
            font-size: 1.3em;
            line-height: 2em;
            cursor: pointer;
            transition: background 1s;
        }

        .btn:hover {
            background-color: rgba(255, 255, 255, 0.4);
            transition: background 1s;
        }
    </style>
    <script>
        var Example = Example || {};

        var ranking = [];

        playerRagdollNo = null;

        Example.ragdoll = function() {
            var Engine = Matter.Engine,
                Events = Matter.Events,
                Render = Matter.Render,
                Runner = Matter.Runner,
                Body = Matter.Body,
                Common = Matter.Common,
                Composite = Matter.Composite,
                Composites = Matter.Composites,
                Constraint = Matter.Constraint,
                MouseConstraint = Matter.MouseConstraint,
                Mouse = Matter.Mouse,
                World = Matter.World,
                Bodies = Matter.Bodies,
                Vector = Matter.Vector;
            var engine = Engine.create(),
                world = engine.world;
            var viewportWidth = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
            var viewportHeight = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);

            var render = Render.create({
                element: document.body,
                engine: engine,
                options: {
                    width: viewportWidth,
                    height: viewportHeight,
                    showAngleIndicator: false,
                    background: 'black',
                    wireframes: false
                }
            });



            var ragdolls = Composite.create();

            function reset() {

                engine.timing.timeScale = 0;
                ranking = [];
                for (i = 0; i < ragdolls.composites.length; i += 1) {

                    var ragdoll = ragdolls.composites[i];
                    Composite.remove(ragdolls, ragdoll);

                }


                for (var i = 32, ragdollNo = 1; i < viewportWidth; i += 100, ragdollNo++) {

                    var ragdoll = Example.ragdoll.ragdoll(i + (Math.floor(Math.random() * 8)), 48, 0.32, {
                        ragdollNo: ragdollNo
                    });

                    Composite.add(ragdolls, ragdoll);

                }

                World.add(world, [ragdolls]);
                var runner = Runner.create();

                Runner.run(runner, engine);
            }

            reset();

            window.reset = reset;

            for (var y = 140, j = 0; y < viewportHeight; y += (viewportHeight / 16), j++) {
                for (var i = 0; i < viewportWidth; i += 50) {
                    if (Math.random() > 0.1) {
                        World.add(world, [Bodies.circle(i + (j % 2 * ((viewportHeight / 16) / 2)) + (Math.floor(Math.random() * 10)), y, 5, {
                            isStatic: true,
                            render: {
                                fillStyle: '#0f0f13'
                            }
                        })]);
                    }

                }
            }

            Render.run(render);

            var runner = Runner.create();

            Runner.run(runner, engine);

            var mouse = Mouse.create(render.canvas),
                mouseConstraint = MouseConstraint.create(engine, {
                    mouse: mouse,
                    constraint: {
                        stiffness: 0.6,
                        length: 0,
                        angularStiffness: 0,
                        render: {
                            visible: false
                        }
                    }
                });

            function ordinal_suffix_of(i) {

                var j = i % 10,
                    k = i % 100;
                if (j == 1 && k != 11) {
                    return i + "st";
                }
                if (j == 2 && k != 12) {
                    return i + "nd";
                }
                if (j == 3 && k != 13) {
                    return i + "rd";
                }
                return i + "th";

            }

            Events.on(mouseConstraint, "mousedown", function(event) {

                document.getElementById('instructions').style.display = 'none';

                for (i = 0; i < ragdolls.composites.length; i += 1) {

                    var ragdoll = ragdolls.composites[i],
                        bounds = Composite.bounds(ragdoll);
                    var mouseEvent = event.mouse.mousedownPosition;

                    if (bounds.min.x < mouseEvent.x && bounds.max.x > mouseEvent.x) {

                        //chest
                        ragdolls.composites[i].bodies[0].render.fillStyle = 'rgba(255,69,0,0.4)';
                        //head
                        ragdolls.composites[i].bodies[1].render.fillStyle = 'rgba(255,69,0,0.6)';

                        //left arm lower
                        ragdolls.composites[i].bodies[2].render.fillStyle = 'rgba(255,69,0,0.8)';

                        //left arm upper
                        ragdolls.composites[i].bodies[3].render.fillStyle = 'rgba(255,69,0,0.6)';

                        //right arm lower
                        ragdolls.composites[i].bodies[4].render.fillStyle = 'rgba(255,69,0,0.8)';

                        //right arm upper
                        ragdolls.composites[i].bodies[5].render.fillStyle = 'rgba(255,69,0,0.6)';

                        //left leg lower
                        ragdolls.composites[i].bodies[6].render.fillStyle = 'rgba(255,69,0,0.8)';

                        //right leg lower
                        ragdolls.composites[i].bodies[7].render.fillStyle = 'rgba(255,69,0,0.8)';

                        //left left upper
                        ragdolls.composites[i].bodies[8].render.fillStyle = 'rgba(255,69,0,0.6)';

                        //right leg upper
                        ragdolls.composites[i].bodies[9].render.fillStyle = 'rgba(255,69,0,0.6)';

                        document.getElementById('running').style.display = 'block';
                        document.getElementById('running-message').innerHTML = "Let's hope <b>#" + ragdoll.label + "</b> wins.";
                        playerRagdollNo = ragdoll.label;
                    }


                }
                engine.timing.timeScale = 0.5;
                setTimeout(function() {
                    for (i = 0; i < ragdolls.composites.length; i += 1) {

                        var ragdoll = ragdolls.composites[i];
                        console.log(ragdoll)
                        //Composite.remove(ragdolls, ragdoll);
                        ragdolls.composites[i].constraints = []
                    }
                }, 10000);

            });

            Events.on(engine, 'afterUpdate', function(event) {

                for (i = 0; i < ragdolls.composites.length; i += 1) {

                    var ragdoll = ragdolls.composites[i],
                        bounds = Composite.bounds(ragdoll);

                    if (bounds.min.y > render.bounds.max.y) {

                        var ragdollNo = ragdoll.label;
                        ranking.unshift(ragdoll.label);
                        Composite.remove(ragdolls, ragdoll);

                        if (ragdollNo == playerRagdollNo) {

                            //engine.timing.timeScale = 1.5;



                        }

                        if (ragdolls.composites.length == 0) {

                            var rankingHTML = '';

                            var playerWin = playerRagdollNo == ragdollNo;

                            if (playerWin) {

                                document.getElementById('ranking-message').innerHTML = '<h2>You win, #' + ragdollNo + '! </h2>';

                            } else {

                                playerRank = 0;
                                for (var j = 0; j < ranking.length; j++) {
                                    if (ranking[j] == playerRagdollNo) {
                                        playerRank = j + 1;
                                    }
                                }
                                document.getElementById('ranking-message').innerHTML = '<h2>You came ' + ordinal_suffix_of(playerRank) + ' </h2>';

                            }

                            for (var j = 0; j < ranking.length; j++) {

                                if (ranking[j] == playerRagdollNo) {

                                    rankingHTML += '<li style="color:orange">#' + ranking[j] + ' came ' + ordinal_suffix_of(j + 1) + '</li>';

                                } else {

                                    rankingHTML += '<li>#' + ranking[j] + ' came ' + ordinal_suffix_of(j + 1) + '</li>';

                                }
                            }

                            document.getElementById('ranking').innerHTML = rankingHTML;
                            document.getElementById('running').style.display = 'none';

                        }

                    }
                    if (bounds.min.x > render.bounds.max.x) {
                        Composite.translate(ragdoll, {
                            x: -render.bounds.max.x,
                            y: 0
                        });
                    } else if (bounds.max.x < render.bounds.min.x) {
                        Composite.translate(ragdoll, {
                            x: render.bounds.max.x,
                            y: 0
                        });
                    }

                }


            });

            Render.lookAt(render, {
                min: {
                    x: 0,
                    y: 0
                },
                max: {
                    x: viewportWidth,
                    y: viewportHeight
                }
            });

            engine.timing.timeScale = 0;

            return {
                engine: engine,
                runner: runner,
                render: render,
                canvas: render.canvas,
                stop: function() {
                    Matter.Render.stop(render);
                    Matter.Runner.stop(runner);
                }
            };
        };

        Example.ragdoll.ragdoll = function(x, y, scale, options) {

            var color1 = {
                red: 0,
                green: 17,
                blue: 91
            };

            var color2 = {
                red: 128,
                green: 9,
                blue: 9
            };

            var fade = (options.ragdollNo / 42);
            var diffRed = color2.red - color1.red;
            var diffGreen = color2.green - color1.green;
            var diffBlue = color2.blue - color1.blue;

            var gradient = {
                red: parseInt(Math.floor(color1.red + (diffRed * fade)), 10),
                green: parseInt(Math.floor(color1.green + (diffGreen * fade)), 10),
                blue: parseInt(Math.floor(color1.blue + (diffBlue * fade)), 10),
            };

            var dollColor = 'rgba(' + gradient.red + ',' + gradient.green + ',' + gradient.blue + ',1)';
            var darkDollColor = 'rgba(' + gradient.red + ',' + gradient.green + ',' + gradient.blue + ',0.8)';
            var darkerDollColor = 'rgba(' + gradient.red + ',' + gradient.green + ',' + gradient.blue + ',0.6)';
            var darkestDollColor = 'rgba(' + gradient.red + ',' + gradient.green + ',' + gradient.blue + ',0.4)';

            scale = typeof scale === 'undefined' ? 1 : scale;

            var Body = Matter.Body,
                Bodies = Matter.Bodies,
                Constraint = Matter.Constraint,
                Composite = Matter.Composite,
                Common = Matter.Common;

            var headOptions = Common.extend({
                label: 'head',
                collisionFilter: {
                    group: Body.nextGroup(true)
                },
                chamfer: {
                    radius: [15 * scale, 15 * scale, 15 * scale, 15 * scale]
                },
                render: {
                    fillStyle: dollColor
                }
            }, options);

            var chestOptions = Common.extend({
                label: 'chest',
                collisionFilter: {
                    group: Body.nextGroup(true)
                },
                chamfer: {
                    radius: [20 * scale, 20 * scale, 26 * scale, 26 * scale]
                },
                render: {
                    fillStyle: darkestDollColor
                }
            }, options);

            var leftArmOptions = Common.extend({
                label: 'left-arm',
                collisionFilter: {
                    group: Body.nextGroup(true)
                },
                chamfer: {
                    radius: 10 * scale
                },
                render: {
                    fillStyle: darkerDollColor
                }
            }, options);

            var leftLowerArmOptions = Common.extend({}, leftArmOptions, {
                render: {
                    fillStyle: darkDollColor
                }
            });

            var rightArmOptions = Common.extend({
                label: 'right-arm',
                collisionFilter: {
                    group: Body.nextGroup(true)
                },
                chamfer: {
                    radius: 10 * scale
                },
                render: {
                    fillStyle: darkerDollColor
                }
            }, options);

            var rightLowerArmOptions = Common.extend({}, rightArmOptions, {
                render: {
                    fillStyle: darkDollColor
                }
            });

            var leftLegOptions = Common.extend({
                label: 'left-leg',
                collisionFilter: {
                    group: Body.nextGroup(true)
                },
                chamfer: {
                    radius: 10 * scale
                },
                render: {
                    fillStyle: darkerDollColor
                }
            }, options);

            var leftLowerLegOptions = Common.extend({}, leftLegOptions, {
                render: {
                    fillStyle: darkDollColor
                }
            });

            var rightLegOptions = Common.extend({
                label: 'right-leg',
                collisionFilter: {
                    group: Body.nextGroup(true)
                },
                chamfer: {
                    radius: 10 * scale
                },
                render: {
                    fillStyle: darkerDollColor
                }
            }, options);

            var rightLowerLegOptions = Common.extend({}, rightLegOptions, {
                render: {
                    fillStyle: darkDollColor
                }
            });

            var head = Bodies.rectangle(x, y - 60 * scale, 34 * scale, 40 * scale, headOptions);
            var chest = Bodies.rectangle(x, y, 55 * scale, 80 * scale, chestOptions);
            var rightUpperArm = Bodies.rectangle(x + 39 * scale, y - 15 * scale, 20 * scale, 40 * scale, rightArmOptions);
            var rightLowerArm = Bodies.rectangle(x + 39 * scale, y + 25 * scale, 20 * scale, 60 * scale, rightLowerArmOptions);
            var leftUpperArm = Bodies.rectangle(x - 39 * scale, y - 15 * scale, 20 * scale, 40 * scale, leftArmOptions);
            var leftLowerArm = Bodies.rectangle(x - 39 * scale, y + 25 * scale, 20 * scale, 60 * scale, leftLowerArmOptions);
            var leftUpperLeg = Bodies.rectangle(x - 20 * scale, y + 57 * scale, 20 * scale, 40 * scale, leftLegOptions);
            var leftLowerLeg = Bodies.rectangle(x - 20 * scale, y + 97 * scale, 20 * scale, 60 * scale, leftLowerLegOptions);
            var rightUpperLeg = Bodies.rectangle(x + 20 * scale, y + 57 * scale, 20 * scale, 40 * scale, rightLegOptions);
            var rightLowerLeg = Bodies.rectangle(x + 20 * scale, y + 97 * scale, 20 * scale, 60 * scale, rightLowerLegOptions);

            var chestToRightUpperArm = Constraint.create({
                bodyA: chest,
                pointA: {
                    x: 24 * scale,
                    y: -23 * scale
                },
                pointB: {
                    x: 0,
                    y: -8 * scale
                },
                bodyB: rightUpperArm,
                stiffness: 0.6,
                render: {
                    visible: false
                }
            });

            var chestToLeftUpperArm = Constraint.create({
                bodyA: chest,
                pointA: {
                    x: -24 * scale,
                    y: -23 * scale
                },
                pointB: {
                    x: 0,
                    y: -8 * scale
                },
                bodyB: leftUpperArm,
                stiffness: 0.6,
                render: {
                    visible: false
                }
            });

            var chestToLeftUpperLeg = Constraint.create({
                bodyA: chest,
                pointA: {
                    x: -10 * scale,
                    y: 30 * scale
                },
                pointB: {
                    x: 0,
                    y: -10 * scale
                },
                bodyB: leftUpperLeg,
                stiffness: 0.6,
                render: {
                    visible: false
                }
            });

            var chestToRightUpperLeg = Constraint.create({
                bodyA: chest,
                pointA: {
                    x: 10 * scale,
                    y: 30 * scale
                },
                pointB: {
                    x: 0,
                    y: -10 * scale
                },
                bodyB: rightUpperLeg,
                stiffness: 0.6,
                render: {
                    visible: false
                }
            });

            var upperToLowerRightArm = Constraint.create({
                bodyA: rightUpperArm,
                bodyB: rightLowerArm,
                pointA: {
                    x: 0,
                    y: 15 * scale
                },
                pointB: {
                    x: 0,
                    y: -25 * scale
                },
                stiffness: 0.6,
                render: {
                    visible: false
                }
            });

            var upperToLowerLeftArm = Constraint.create({
                bodyA: leftUpperArm,
                bodyB: leftLowerArm,
                pointA: {
                    x: 0,
                    y: 15 * scale
                },
                pointB: {
                    x: 0,
                    y: -25 * scale
                },
                stiffness: 0.6,
                render: {
                    visible: false
                }
            });

            var upperToLowerLeftLeg = Constraint.create({
                bodyA: leftUpperLeg,
                bodyB: leftLowerLeg,
                pointA: {
                    x: 0,
                    y: 20 * scale
                },
                pointB: {
                    x: 0,
                    y: -20 * scale
                },
                stiffness: 0.6,
                render: {
                    visible: false
                }
            });

            var upperToLowerRightLeg = Constraint.create({
                bodyA: rightUpperLeg,
                bodyB: rightLowerLeg,
                pointA: {
                    x: 0,
                    y: 20 * scale
                },
                pointB: {
                    x: 0,
                    y: -20 * scale
                },
                stiffness: 0.6,
                render: {
                    visible: false
                }
            });

            var headContraint = Constraint.create({
                bodyA: head,
                pointA: {
                    x: 0,
                    y: 25 * scale
                },
                pointB: {
                    x: 0,
                    y: -35 * scale
                },
                bodyB: chest,
                stiffness: 0.6,
                render: {
                    visible: false
                }
            });

            var legToLeg = Constraint.create({
                bodyA: leftLowerLeg,
                bodyB: rightLowerLeg,
                stiffness: 0.01,
                render: {
                    visible: false
                }
            });

            var person = Composite.create({
                bodies: [
                    chest, head, leftLowerArm, leftUpperArm,
                    rightLowerArm, rightUpperArm, leftLowerLeg,
                    rightLowerLeg, leftUpperLeg, rightUpperLeg
                ],
                constraints: [
                    upperToLowerLeftArm, upperToLowerRightArm, chestToLeftUpperArm,
                    chestToRightUpperArm, headContraint, upperToLowerLeftLeg,
                    upperToLowerRightLeg, chestToLeftUpperLeg, chestToRightUpperLeg,
                    legToLeg
                ],
                label: options.ragdollNo,
                isStatic: true
            });

            return person;
        };
        Example.ragdoll();
    </script>
</body>
